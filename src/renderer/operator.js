// Interface Op√©rateur - Logique de contr√¥le
class OperatorController {
    constructor() {
        this.state = {
            condition: 'human',
            currentState: 'idle',
            fadeSpeed: 500,
            volume: 0.8,
            isPlaying: false
        };

        this.logs = [];
        this.maxLogs = 100;
        
        this.veilActive = true; // Le voile est actif au d√©marrage
        
        this.init();
    }

    async init() {
        // R√©cup√©rer l'√©tat initial
        try {
            this.state = await window.electronAPI.getState();
            this.updateUI();
        } catch (error) {
            this.addLog('error', 'Erreur de connexion au processus principal');
        }

        // Initialiser les listeners
        this.setupEventListeners();
        this.setupIPCListeners();
        
        // D√©marrer l'horloge
        this.startClock();
        
        // Pr√©charger les m√©dias critiques
        this.preloadCriticalMedia();
        
        this.addLog('info', 'Interface op√©rateur initialis√©e');
    }

    setupEventListeners() {
        // Changement de condition
        document.getElementById('conditionHuman').addEventListener('click', () => {
            this.changeCondition('human');
        });

        document.getElementById('conditionAbstract').addEventListener('click', () => {
            this.changeCondition('abstract');
        });

        // Sliders
        const fadeSpeedSlider = document.getElementById('fadeSpeed');
        fadeSpeedSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            document.getElementById('fadeSpeedValue').textContent = `${value}ms`;
            this.setFadeSpeed(value);
        });

        const volumeSlider = document.getElementById('volume');
        volumeSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            document.getElementById('volumeValue').textContent = `${value}%`;
            this.setVolume(value / 100);
        });

        // Boutons d'√©tat
        document.getElementById('stateWelcome').addEventListener('click', () => {
            this.playMedia('welcome');
        });

        document.getElementById('stateIdle').addEventListener('click', () => {
            this.playMedia('idle');
        });

        document.getElementById('stateClosing').addEventListener('click', () => {
            this.playMedia('closing');
        });

        // Questions
        document.querySelectorAll('.question-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const question = e.currentTarget.dataset.question;
                this.playMedia(question);
            });
        });

        // Bouton STOP
        document.getElementById('stopBtn').addEventListener('click', () => {
            this.stopMedia();
        });
        
        // Bouton Reset
        document.getElementById('resetBtn').addEventListener('click', () => {
            this.resetToIdle();
        });
        
        // Bouton Voile
        document.getElementById('toggleVeil').addEventListener('click', () => {
            this.toggleVeil();
        });
        
        // Pr√©chargement
        document.getElementById('preloadBtn').addEventListener('click', () => {
            this.preloadAllMedia();
        });

        // Contr√¥le plein √©cran
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            this.toggleFullscreen();
        });

        // Logs
        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            this.clearLogs();
        });

        document.getElementById('exportLogsBtn').addEventListener('click', () => {
            this.exportLogs();
        });
    }

    setupIPCListeners() {
        // Mise √† jour d'√©tat
        window.electronAPI.onStateUpdate((state) => {
            this.state = state;
            this.updateUI();
        });

        // Fin de m√©dia
        window.electronAPI.onMediaEnded((mediaId) => {
            this.addLog('info', `M√©dia termin√©: ${mediaId}`);
            this.updatePlayingState(null);
        });

        // Erreur m√©dia
        window.electronAPI.onMediaError((error) => {
            this.addLog('error', `Erreur m√©dia: ${error.message || error}`);
        });

        // Changement d'√©tat plein √©cran
        window.electronAPI.onFullscreenChanged((isFullscreen) => {
            this.updateFullscreenStatus(isFullscreen);
        });
    }

    async changeCondition(condition) {
        if (this.state.isPlaying) {
            this.addLog('warning', 'Arr√™t du m√©dia en cours avant changement de condition');
            await this.stopMedia();
        }

        try {
            const result = await window.electronAPI.changeCondition(condition);
            if (result.success) {
                this.addLog('success', `Condition chang√©e: ${condition === 'human' ? 'Humain' : 'Abstrait'}`);
                
                // Mise √† jour UI
                document.querySelectorAll('.condition-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(condition === 'human' ? 'conditionHuman' : 'conditionAbstract').classList.add('active');
                
                // Log pour l'exp√©rience
                await window.electronAPI.writeLog({
                    action: 'condition_change',
                    condition: condition,
                    timestamp: new Date().toISOString()
                });
            }
        } catch (error) {
            this.addLog('error', `Erreur changement condition: ${error.message}`);
        }
    }

    async playMedia(mediaId) {
        if (this.state.isPlaying) {
            this.addLog('warning', 'Un m√©dia est d√©j√† en cours de lecture');
            return;
        }

        try {
            const result = await window.electronAPI.playMedia(mediaId);
            if (result.success) {
                this.addLog('success', `Lecture: ${this.getMediaLabel(mediaId)}`);
                this.state.isPlaying = true;
                this.state.currentState = mediaId;
                this.updatePlayingState(mediaId);
                
                // Log pour l'exp√©rience
                await window.electronAPI.writeLog({
                    action: 'play_media',
                    mediaId: mediaId,
                    condition: this.state.condition,
                    timestamp: new Date().toISOString()
                });
            }
        } catch (error) {
            this.addLog('error', `Erreur lecture: ${error.message}`);
        }
    }

    async stopMedia() {
        try {
            const result = await window.electronAPI.stopMedia();
            if (result.success) {
                this.addLog('info', 'Arr√™t du m√©dia');
                this.state.isPlaying = false;
                this.state.currentState = 'idle';
                this.updatePlayingState(null);
                
                // Log pour l'exp√©rience
                await window.electronAPI.writeLog({
                    action: 'stop_media',
                    timestamp: new Date().toISOString()
                });
            }
        } catch (error) {
            this.addLog('error', `Erreur arr√™t: ${error.message}`);
        }
    }
    
    async resetToIdle() {
        this.addLog('info', 'R√©initialisation vers Idle...');
        
        // Arr√™ter d'abord tout m√©dia en cours
        await this.stopMedia();
        
        // Attendre un peu
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Relancer l'idle
        await this.playMedia('idle');
        
        this.addLog('success', 'R√©initialisation r√©ussie');
    }
    
    async toggleVeil() {
        this.veilActive = !this.veilActive;
        
        try {
            const result = await window.electronAPI.toggleVeil(this.veilActive);
            if (result.success) {
                // Mettre √† jour le bouton
                const btn = document.getElementById('toggleVeil');
                if (this.veilActive) {
                    btn.textContent = 'üé≠ Retirer le voile noir';
                    btn.classList.remove('warning');
                    btn.classList.add('primary');
                    this.addLog('info', 'Voile noir activ√©');
                } else {
                    btn.textContent = 'üé≠ Remettre le voile noir';
                    btn.classList.remove('primary');
                    btn.classList.add('warning');
                    this.addLog('success', 'Voile noir retir√© - Les participants peuvent voir l\'agent');
                }
            }
        } catch (error) {
            this.addLog('error', `Erreur contr√¥le voile: ${error.message}`);
        }
    }

    async setFadeSpeed(speed) {
        try {
            const result = await window.electronAPI.setFadeSpeed(speed);
            if (result.success) {
                this.state.fadeSpeed = result.fadeSpeed;
                this.addLog('info', `Vitesse de fondu: ${result.fadeSpeed}ms`);
            }
        } catch (error) {
            this.addLog('error', `Erreur r√©glage fondu: ${error.message}`);
        }
    }

    async setVolume(volume) {
        try {
            const result = await window.electronAPI.setVolume(volume);
            if (result.success) {
                this.state.volume = result.volume;
                this.addLog('info', `Volume: ${Math.round(result.volume * 100)}%`);
            }
        } catch (error) {
            this.addLog('error', `Erreur r√©glage volume: ${error.message}`);
        }
    }

    async preloadCriticalMedia() {
        const criticalMedia = ['idle', 'welcome', 'closing'];
        try {
            const result = await window.electronAPI.preloadMedia(criticalMedia);
            if (result.success) {
                this.addLog('success', `M√©dias critiques pr√©charg√©s: ${result.preloaded.join(', ')}`);
            }
        } catch (error) {
            this.addLog('error', `Erreur pr√©chargement: ${error.message}`);
        }
    }

    async preloadAllMedia() {
        const allMedia = ['idle', 'welcome', 'closing', 'q1', 'q2', 'q3', 'q4', 'q5', 'q6'];
        try {
            this.addLog('info', 'Pr√©chargement de tous les m√©dias...');
            const result = await window.electronAPI.preloadMedia(allMedia);
            if (result.success) {
                this.addLog('success', `Tous les m√©dias pr√©charg√©s (${result.preloaded.length} fichiers)`);
            }
        } catch (error) {
            this.addLog('error', `Erreur pr√©chargement: ${error.message}`);
        }
    }

    async toggleFullscreen() {
        try {
            const result = await window.electronAPI.toggleFullscreen();
            if (result.success) {
                this.updateFullscreenStatus(result.isFullscreen);
                this.addLog('info', `Mode ${result.isFullscreen ? 'plein √©cran' : 'fen√™tr√©'} activ√©`);
            }
        } catch (error) {
            this.addLog('error', `Erreur changement plein √©cran: ${error.message}`);
        }
    }

    updateFullscreenStatus(isFullscreen) {
        const statusDiv = document.getElementById('fullscreenStatus');
        const btn = document.getElementById('fullscreenBtn');
        
        if (isFullscreen) {
            statusDiv.textContent = 'Mode: Plein √âcran';
            statusDiv.style.color = '#48bb78';
            btn.innerHTML = 'üî≥ Quitter Plein √âcran';
        } else {
            statusDiv.textContent = 'Mode: Fen√™tr√©';
            statusDiv.style.color = '#5a67d8';
            btn.innerHTML = 'üî≤ Basculer Plein √âcran';
        }
    }

    updateUI() {
        // Mise √† jour des statuts
        document.getElementById('currentCondition').textContent = 
            this.state.condition === 'human' ? 'Humain' : 'Abstrait';
        
        document.getElementById('currentState').textContent = 
            this.getMediaLabel(this.state.currentState);
        
        document.getElementById('playStatus').textContent = 
            this.state.isPlaying ? '‚ñ∂Ô∏è Lecture' : '‚è∏Ô∏è Arr√™t√©';

        // Mise √† jour des contr√¥les
        document.getElementById('fadeSpeed').value = this.state.fadeSpeed;
        document.getElementById('fadeSpeedValue').textContent = `${this.state.fadeSpeed}ms`;
        
        document.getElementById('volume').value = this.state.volume * 100;
        document.getElementById('volumeValue').textContent = `${Math.round(this.state.volume * 100)}%`;

        // Mise √† jour des boutons de condition
        document.querySelectorAll('.condition-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeCondBtn = this.state.condition === 'human' ? 'conditionHuman' : 'conditionAbstract';
        document.getElementById(activeCondBtn).classList.add('active');
    }

    updatePlayingState(mediaId) {
        // Retirer tous les √©tats playing
        document.querySelectorAll('.question-btn, .state-btn').forEach(btn => {
            btn.classList.remove('playing', 'active');
        });

        // Ajouter l'√©tat playing au bouton actif
        if (mediaId) {
            if (mediaId.startsWith('q')) {
                const btn = document.querySelector(`[data-question="${mediaId}"]`);
                if (btn) btn.classList.add('playing');
            } else {
                const stateBtn = document.getElementById(`state${mediaId.charAt(0).toUpperCase() + mediaId.slice(1)}`);
                if (stateBtn) stateBtn.classList.add('active');
            }
        }

        // Mise √† jour du statut
        document.getElementById('playStatus').textContent = 
            mediaId ? '‚ñ∂Ô∏è Lecture' : '‚è∏Ô∏è Arr√™t√©';
    }

    getMediaLabel(mediaId) {
        const labels = {
            'idle': 'Idle',
            'welcome': 'Welcome',
            'closing': 'Closing',
            'q1': 'Q1 - Transport',
            'q2': 'Q2 - Organisation',
            'q3': 'Q3 - Techniques',
            'q4': 'Q4 - Dur√©e',
            'q5': 'Q5 - Ouvriers',
            'q6': 'Q6 - Myst√®res'
        };
        return labels[mediaId] || mediaId;
    }

    addLog(type, message) {
        const timestamp = new Date().toLocaleTimeString('fr-FR');
        const logEntry = {
            type,
            message,
            timestamp
        };

        this.logs.push(logEntry);
        if (this.logs.length > this.maxLogs) {
            this.logs.shift();
        }

        this.renderLog(logEntry);
    }

    renderLog(logEntry) {
        const container = document.getElementById('logsContainer');
        const entry = document.createElement('div');
        entry.className = `log-entry ${logEntry.type} fade-in`;
        entry.innerHTML = `
            <span class="log-time">${logEntry.timestamp}</span>
            ${logEntry.message}
        `;
        container.appendChild(entry);
        
        // Scroll vers le bas
        container.scrollTop = container.scrollHeight;

        // Limiter le nombre d'entr√©es affich√©es
        while (container.children.length > this.maxLogs) {
            container.removeChild(container.firstChild);
        }
    }

    clearLogs() {
        this.logs = [];
        document.getElementById('logsContainer').innerHTML = '';
        this.addLog('info', 'Logs effac√©s');
    }

    exportLogs() {
        const logText = this.logs.map(log => {
            return `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`;
        }).join('\n');

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `logs-${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        this.addLog('success', 'Logs export√©s');
    }

    startClock() {
        const updateClock = () => {
            const now = new Date();
            const time = now.toLocaleTimeString('fr-FR');
            document.getElementById('clock').textContent = time;
        };

        updateClock();
        setInterval(updateClock, 1000);
    }
}

// D√©marrage de l'application
let controller;

document.addEventListener('DOMContentLoaded', () => {
    controller = new OperatorController();
});

// Nettoyage avant fermeture
window.addEventListener('beforeunload', () => {
    if (window.electronAPI && window.electronAPI.removeAllListeners) {
        window.electronAPI.removeAllListeners();
    }
});
